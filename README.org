* SSH Related Policy

** inventory_ssh_host_key_fingerprints
This policy will inventory ssh host key fingerprints that are found on the system.

SSH Host key fingerprints are derived from files ending in `.pub` located in
`/etc/ssh`.

[[images/inventory_ssh_host_key_fingerprint_dsa.jpg]]

** inventory_duplicate_ssh_host_key_fingerprints
This policy relies on inventory_ssh_host_key_fingerprints being
active. This policy is designed to run on a CFEngine Enterprise Hub.

[[images/inventory_duplicate_ssh_host_key_fingerprint_dsa.jpg]]

*** inventory_duplicate_ssh_host_key_fingerprints_data

This policy will generate duplicate host key data that will be used for
inventory and alerting.

*** inventory_duplicate_ssh_host_key_fingerprints_report

This policy uses the data generated by
inventory_duplicate_ssh_host_key_fingerprints_data to inventory hosts found to
have duplicate keys.

*** Saved seports showing duplicate hosts
For each type of ssh host key in your infrastrucutre (DSA, RSA, RSA1, etc ...)
you may want to create a saved report for quick access.

Here is an example of a SQL query to show duplicate DSA keys.

#+beign_src sql
SELECT sub.value as "SSH Host Fingerprint (DSA)",
        sub.hostkeys as "Host Identity"
FROM (SELECT variablevalue as value,
          array_agg(hostkey) as hostkeys,
          count(*)
     FROM variables
     WHERE 'attribute_name=SSH Host Fingerprint (DSA)' = ANY(metatags) group by variablevalue )
     AS sub where sub.count > 1 order by sub.count desc
#+end_src

[[images/inventory_duplicate_ssh_host_key_fingerprints_saved_report.jpg]]

*** Alerts
You can setup alerts based on the inventoried duplicate ssh host keys.

1) Create a new widget named "Duplicate SSH Host Key"
   [[images/inventory_duplicate_ssh_host_key_fingerprints_create_dashboard_widget.jpg]]

2) Create a new alert named "Duplicate DSA SSH Host Key" and set the severity appropirately for your environment.
   [[images/inventory_duplicate_ssh_host_key_fingerprints_create_alert.jpg]]

3) Create a new condition named "Duplicate DSA SSH Host Key"
   a) Set the condition type to "Inventory"
   b) Select the "Duplicate SSH Host Keys (DSA)" attribute
   c) Set the match to "contains" (because its a list) with "%" as the value (to match anything)

   [[images/inventory_duplicate_ssh_host_key_fingerprints_create_condition.jpg]]
